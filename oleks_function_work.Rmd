---
title: "Olek's Function Work"
author: "Olek Wojcik"
date: "4/22/2021"
output: pdf_document
---
```{r}
library(tidyverse)
library(sf)
library(pdxTrees)
library(lwgeom)
```

```{r}
set.seed(13)

pdx <- get_pdxTrees_parks() %>%
  sample_n(100)

pdx_sf <- st_as_sf(pdx,
                   coords = c("Longitude", "Latitude"),
                   crs = 4326)

#I don't think we need these helper functions, I used a simpler method below, lmk if I missed something. 
# one_nn_distance <- function(sf_object, one_row, ...){
#   sf_object %>%
#     mutate(distance_temporary_column = as.numeric(st_distance(one_row, sf_object, ...)))%>%
#     #shouldnt make a new column like this
#     filter(distance_temporary_column != 0) %>%
#     #what do we do if multiple points are on the same spot?
#     summarize(m = min(distance_temporary_column)) %>%
#     as.data.frame() %>%
#     dplyr::select(m) %>%
#     as.numeric()
# }
# 
# pdx_one <- slice_head(pdx_sf, n = 1)
# 
# 
# sf_nn_distances <- function(sf_object, ...){
#   sf_object %>%
#     rowwise() %>%
#     mutate(distance = one_nn_distance(sf_object = sf_object,
#                                       one_row = geometry, ...))
#   }
pdx_dist <- sf_nn_distances(pdx_sf)
```


##G Function
```{r}
g_function <- function(sf_object, ...){
  g <- st_distance(sf_object)
gm <- as.matrix(g)
diag(gm) <- NA
distances <- apply(gm, 1, min, na.rm=TRUE)
  max_dist <- max(distances)
  distances_df <- data.frame(distances = distances)
  
  d <- seq(from = 0, to = max_dist, by = max_dist/100)
  
  props <- d %>%
    map_dbl(.f = function(.){
      #print(distances_df$distances > .)
      mutate(distances_df,
             true = case_when(distances < . ~ 1,
                              distances >= . ~ 0)) %>%
        summarize(prop = mean(true)) %>%
        as.double()
    })
  
  data.frame(distance = d,
             prop = props)
}

g_df <- g_function(pdx_sf)

ggplot(data = g_df,
       mapping = aes(x = distance,
                     y = prop)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue") +
  theme_minimal() +
  labs(title = "G-Function")
```


##F Function
```{r}
set.seed(20)
f_function <- function(sf_object, ...){
  #First generating random points
   bb_studyregion = st_bbox(sf_object) # the study region's bounds
  random_df = tibble(
  x = runif(n = length(sf_object), min = bb_studyregion[1], max = bb_studyregion[3]),
  y = runif(n = length(sf_object), min = bb_studyregion[2], max = bb_studyregion[4])
  )
  random_points = random_df %>% 
  st_as_sf(coords = c("x", "y")) %>% # set coordinates
  st_set_crs(4326) # set geographic CRS 
 #prepping for the F-function formula
  dt <- st_distance(random_points, sf_object$geometry)
  dm <- as.matrix(dt)
  distances <- apply(dm, 1, min, na.rm=TRUE)
  max_dist <- max(distances)
  distances_df <- data.frame(distances = distances)
  d <- seq(from = 0, to = max_dist, by = max_dist/100)
  props <- d %>%
    map_dbl(.f = function(.){
      #print(distances_df$distances > .)
      mutate(distances_df,
             true = case_when(distances < . ~ 1,
                              distances >= . ~ 0)) %>%
        summarize(prop = mean(true)) %>%
        as.double()
    })
  data.frame(distance = d,
             prop = props)
}
f_df <- f_function(pdx_sf)
ggplot(data = f_df,
       mapping = aes(x = distance,
                     y = prop)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue") +
  theme_minimal() +
  labs(title = "F-Function")
```


##K Function
```{r}
library(geosphere)
set.seed(20)
pol <-  st_as_sfc(st_bbox(pdx_sf))
pdx_area <- st_area(pol)
pdx_dens <- pdx_area/nrow(pdx_sf)

#distance
xy <- st_coordinates(pdx_sf)
xy <- unique(xy)
d <- dist(xy)
head(d)

#What we did in class
dist <- seq(1, 30000, 100)
Kd <- sapply(dist, function(x) sum(d < x)) # takes a while
Kd <- Kd / (length(Kd) * dens)
K_df <- data.frame(distance = dist, Kd=Kd)
ggplot(data = K_df,
       mapping = aes(x = distance,
                     y = Kd)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue") +
  theme_minimal() +
  labs(title = "K-Function")
```


```{r}
#trash experimental functions
one_nn <- function(one_row, sf_object){
  sf_object %>%
    mutate(distance_temporary_column = as.numeric(st_distance(one_row, sf_object)))%>%
    #shouldnt make a new column like this
    filter(distance_temporary_column != 0) %>%
    #what do we do if multiple points are on the same spot?
    filter(distance_temporary_column == min(distance_temporary_column)) %>%
    select(-distance_temporary_column)
}

sf_nn <- function(sf_object){
  sf_object %>%
    rowwise() %>%
    map(.f = function(.){
      #one_geom <- st_transform(., crs = 4326)
      one_nn(., sf_object)
    })
}
```


